
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Eager Loading - Lightpack Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#eager-loading" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Lightpack Documentation" class="md-header__button md-logo" aria-label="Lightpack Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lightpack Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Eager Loading
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/lightpack/docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    lightpack/docs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../index.md" class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../introduction/" class="md-tabs__link">
        
  
  
    
  
  Introduction

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../install/" class="md-tabs__link">
        
  
  
    
  
  Installation

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../getting-started.md" class="md-tabs__link">
        
  
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../authentication/" class="md-tabs__link">
          
  
  
  Guides

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Lightpack Documentation" class="md-nav__button md-logo" aria-label="Lightpack Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Lightpack Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lightpack/docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    lightpack/docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../authentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Authentication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../relationships/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Relationships
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../orm-introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ORM Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../..." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    None
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="eager-loading">Eager Loading<a class="headerlink" href="#eager-loading" title="Permanent link">&para;</a></h1>
<p>Once again let us consider these three tables:</p>
<table>
    <tr>
        <td class="token title important">products</td>
        <td>id</td>
        <td>title</td>
    </tr>
</table>
<table>
    <tr>
        <td class="token title important">options</td>
        <td>id</td>
        <td>product_id</td>
        <td>name</td>
        <td>color</td>
    </tr>
</table>
<table>
    <tr>
        <td class="token title important">seo</td>
        <td>id</td>
        <td>product_id</td>
        <td>meta_title</td>
        <td>meta_description</td>
    </tr>
</table>

<p>The association between these entities is:</p>
<ul>
<li>A <strong>product</strong> has many <strong>options</strong>.</li>
<li>A <strong>product</strong> has one <strong>seo</strong> details.</li>
</ul>
<pre><code class="language-php">class Product extends Model
{
    public function options()
    {
        return $this-&gt;hasMany(Option::class, 'product_id');
    }

    public function seo()
    {
        return $this-&gt;hasOne(Seo::class, 'product_id');
    }
}
</code></pre>
<p>Now suppose we have <strong>20</strong> <strong>products</strong> and correspondingly <strong>20 seo</strong> records. To fetch <code>products</code> along with their <code>seo</code> details, you can simply loop each product:</p>
<pre><code class="language-php">$products = Product::query()-&gt;all();

foreach($products as $product) {
    echo $product-&gt;seo-&gt;meta_title;
}
</code></pre>
<p>The problem with above approach is that it will fire one query for fetching all <code>products</code>
and <strong>20</strong> extra queries per product to fetch <code>seo</code> data. This will result in a total of <code>21 queries</code> which can be expensive.</p>
<p>In raw SQL terms, following queries will be executed</p>
<pre><code class="language-sql">-- 1 query to fetch all products
SELECT * FROM products;

-- 20 queries (one per product) to fetch seo details
SELECT * FROM seo WHERE product_id = 1;
SELECT * FROM seo WHERE product_id = 2;
SELECT * FROM seo WHERE product_id = 3;
-- ...and so on, up to product_id = 20
SELECT * FROM seo WHERE product_id = 20;
</code></pre>
<blockquote>
<p><strong>This is known as the classic <code>N+1</code> queries problem</strong>. </p>
</blockquote>
<p>For every <strong>product</strong>, the ORM issues an additional query to fetch its related <strong>SEO</strong> record—quickly adding up to many unnecessary database calls and poor performance.</p>
<p><strong>Eager loading</strong> is a technique designed to solve this problem. Instead of fetching related data one record at a time, eager loading retrieves all the necessary related records in as few queries as possible—usually just one extra query, no matter how many products you have. This dramatically reduces database load and speeds up your application, especially when displaying lists of records with their associations.</p>
<p>In Lightpack ORM, eager loading is simple and explicit, empowering you to write efficient, high-performance code with minimal effort.</p>
<h3 id="single-ended-associations">Single-ended Associations<a class="headerlink" href="#single-ended-associations" title="Permanent link">&para;</a></h3>
<p>To eager load <strong>single-ended</strong> associations aka <code>1:1</code> mapping, use <code>with()</code> method:</p>
<pre><code class="language-php">$products = Product::query()-&gt;with('seo')-&gt;all();
</code></pre>
<p>This will fetch all products and corresponding seo records with just two queries:</p>
<pre><code class="language-sql">select * from products;

select * from seo where product_id in (1,2,3,4,5,...,N)
</code></pre>
<p>So you can loop each product and access its seo data:</p>
<pre><code class="language-php">foreach($products as $product) {
    echo $product-&gt;seo-&gt;meta_title;
}
</code></pre>
<h3 id="one-to-many-associations">One-to-many Associations<a class="headerlink" href="#one-to-many-associations" title="Permanent link">&para;</a></h3>
<p>To eager load <code>1:N</code> associations, use the same <code>with</code> method passing it the associated method name as string:</p>
<pre><code class="language-php">$products = Product::query()-&gt;with('options')-&gt;all();
</code></pre>
<h3 id="loading-multiple-associations">Loading multiple associations<a class="headerlink" href="#loading-multiple-associations" title="Permanent link">&para;</a></h3>
<p>To eager load multiple associations, pass associated method names in the <code>with</code> method:</p>
<pre><code class="language-php">$products = Product::query()-&gt;with('seo', 'options')-&gt;all();
</code></pre>
<h3 id="counting-associations">Counting associations<a class="headerlink" href="#counting-associations" title="Permanent link">&para;</a></h3>
<p>To count the associated relations, use <code>withCount()</code> method:</p>
<pre><code class="language-php">$categories = Category::query()-&gt;withCount('products')-&gt;all();
</code></pre>
<blockquote>
<p><strong>How do you access the count?</strong></p>
<p>When you use <code>withCount()</code> or <code>loadCount()</code> in Lightpack, the ORM automatically adds a <code>_count</code> suffix to the relation property. For example, after calling <code>withCount('comments')</code>, you can access the count using <code>$post-&gt;comments_count</code>. This naming convention keeps your model properties clear and intention-revealing.</p>
</blockquote>
<p>For example:</p>
<pre><code class="language-php">$categories = Category::query()-&gt;withCount('products')-&gt;all();

foreach($categories as $category) {
    echo $category-&gt;products_count;
}
</code></pre>
<hr />
<h3 id="quick-reference-eager-loading-methods">Quick Reference: Eager Loading Methods<a class="headerlink" href="#quick-reference-eager-loading-methods" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Use When...</th>
<th>For fetching...</th>
<th>Example Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>with()</code></td>
<td>Related models</td>
<td><code>with('seo')</code>, <code>with('options')</code></td>
</tr>
<tr>
<td><code>withCount()</code></td>
<td>Count of relations</td>
<td><code>withCount('products')</code></td>
</tr>
<tr>
<td><code>load()</code> (on collection)</td>
<td>Related models</td>
<td><code>$products-&gt;load('seo')</code></td>
</tr>
<tr>
<td><code>loadCount()</code> (on collection)</td>
<td>Count of relations</td>
<td><code>$products-&gt;loadCount('options')</code></td>
</tr>
</tbody>
</table>
<ul>
<li>Use <code>with()</code> and <code>withCount()</code> when building your initial query.</li>
<li>Use <code>load()</code> and <code>loadCount()</code> to eager load associations on an <strong>existing collection</strong>.</li>
</ul>
<hr />
<h3 id="eager-loading-callbacks-filtering-related-data">Eager Loading Callbacks: Filtering Related Data<a class="headerlink" href="#eager-loading-callbacks-filtering-related-data" title="Permanent link">&para;</a></h3>
<p>You can pass a callback to <code>with()</code>, <code>withCount()</code>, <code>load()</code>, or <code>loadCount()</code> to apply conditions to the eager loaded relationship. The callback receives the query builder for the related model, letting you add any filters you need.</p>
<pre><code class="language-php">$projects = Project::query()-&gt;with(['tasks' =&gt; function($q) {
    $q-&gt;where('status', '=', 'pending');
}])-&gt;all();
</code></pre>
<p>Here, only tasks with status <code>pending</code> are eager loaded for each project.</p>
<p>You can also nest callbacks for deeper relations:</p>
<pre><code class="language-php">$projects = Project::query()-&gt;with([
    'tasks' =&gt; function($q) {
        $q-&gt;where('status', '=', 'pending');
        $q-&gt;with(['comments' =&gt; function($q) {
            $q-&gt;where('status', '=', 'approved');
        }]);
    }
])-&gt;all();
</code></pre>
<hr />
<h3 id="chaining-and-composing-eager-loading-methods">Chaining and Composing Eager Loading Methods<a class="headerlink" href="#chaining-and-composing-eager-loading-methods" title="Permanent link">&para;</a></h3>
<p>Lightpack ORM allows you to fluently chain eager loading methods with other query builder methods for expressive, composable queries. For example:</p>
<pre><code class="language-php">$projects = Project::query()
    -&gt;with('manager')
    -&gt;withCount('tasks')
    -&gt;where('status', '=', 'active')
    -&gt;orderBy('created_at', 'desc')
    -&gt;all();
</code></pre>
<p>This query fetches all active projects, eager loads the manager, counts the tasks, orders by creation date, and returns the results—all in a single, readable chain.</p>
<hr />
<h3 id="nested-eager-loading">Nested Eager Loading<a class="headerlink" href="#nested-eager-loading" title="Permanent link">&para;</a></h3>
<p>Suppose we have table <code>projects</code> with many <code>tasks</code> and each task can have many <code>comments</code>. We can <strong>eager load</strong> <code>projects</code> with their <code>tasks</code> and <code>comments</code> together:</p>
<pre><code class="language-php">$projects = Project::query()-&gt;with('tasks.comments')-&gt;all();
</code></pre>
<p>Note that such convinience can become a performance issue if there are too many <code>comments</code> for <code>tasks</code> for a given project.</p>
<h3 id="conditional-eager-loading">Conditional Eager Loading<a class="headerlink" href="#conditional-eager-loading" title="Permanent link">&para;</a></h3>
<p>You can restrict <strong>eager loading</strong> relations via <code>callback</code> functions. For example, to eager load all pending <code>tasks</code> for <code>projects</code>:</p>
<pre><code class="language-php">$projects = Project::query()-&gt;with(['tasks' =&gt; function($q) {
    $q-&gt;where('status', '=', 'pending');
})-&gt;all();
</code></pre>
<p>You can also restrict <strong>nested</strong> eager loading. For example. to eager load <code>projects</code> with <strong>pending</strong> <code>tasks</code> and <strong>approved</strong> <code>comments</code>:</p>
<pre><code class="language-php">$projects = Project::query()-&gt;with(['tasks' =&gt; function($q) {
    // Load tasks with pending status
    $q-&gt;where('status', '=', 'pending');

    // Load comments with approved status
    $q-&gt;with(['comments' =&gt; function($q) {
        $q-&gt;where('status', =, 'approved');
    }]);
})-&gt;all();
</code></pre>
<p><strong>Note:</strong> You can apply the same constraints on <code>withCount()</code> method too:</p>
<pre><code class="language-php">$projects = Project::query()-&gt;withCount(['tasks' =&gt; function($q) {
    $q-&gt;where('status', '=', 'pending');
})-&gt;all();
</code></pre>
<h3 id="deferred-eager-loading">Deferred eager loading<a class="headerlink" href="#deferred-eager-loading" title="Permanent link">&para;</a></h3>
<p>Suppose that we have <code>100</code> records in products table. Eager loading <code>seo</code> and <code>options</code> for <code>100</code> products will be a huge performance miss.</p>
<p>In such cases, you might be interested in <strong>paginating</strong> <code>products</code> and then eager load associated relations.</p>
<pre><code class="language-php">$products = Product::query()-&gt;paginate(10);
</code></pre>
<p>Once you have got the <strong>products</strong>, you can eager load its <strong>associated</strong> relations by calling <code>load()</code> and <code>loadCount()</code> methods on <strong>products</strong>.</p>
<pre><code class="language-php">$products-&gt;load('seo');
$products-&gt;loadCount('options');
</code></pre>
<p>This will automatically populate <code>seo</code> data along with <code>options</code> count for each product in <code>$products</code> collection.</p>
<pre><code class="language-php">foreach($products as $product) {
    $product-&gt;seo; 
    $product-&gt;options_count;
}
</code></pre>
<p><strong>Note:</strong> You can also chain <code>load()</code> and <code>loadCount()</code> methods together. For example:</p>
<pre><code class="language-php">$products = Product::query()-&gt;paginate(10);
$products-&gt;load('seo')-&gt;loadCount('options');
</code></pre>
<p><strong>Note:</strong> All the capabilities that <code>with()</code> and <code>withCount()</code> methods have also applies to <code>load()</code> and <code>loadCount()</code> methods.</p>
<p>For example, you can pass provide <strong>callbacks</strong> to restric eager loading:</p>
<pre><code class="language-php">$products-&gt;load(['reviews' =&gt; function($q) {
    $q-&gt;where('status', '=', 'approved');
}]);
</code></pre>
<pre><code class="language-php">$products-&gt;loadCount(['reviews' =&gt; function($q) {
    $q-&gt;where('status', '=', 'approved');
}]);
</code></pre>
<hr />
<h4 id="eager-loading-polymorphic-parents-with-loadmorphs">Eager Loading Polymorphic Parents with <code>loadMorphs</code><a class="headerlink" href="#eager-loading-polymorphic-parents-with-loadmorphs" title="Permanent link">&para;</a></h4>
<p>When working with a collection of polymorphic models (e.g., a list of comments where each comment could belong to a different parent type), eager loading the parent models efficiently can be challenging. Lightpack ORM provides the <code>loadMorphs()</code> method to solve this elegantly.</p>
<h5 id="why-use-loadmorphs">Why use <code>loadMorphs()</code>?<a class="headerlink" href="#why-use-loadmorphs" title="Permanent link">&para;</a></h5>
<p>If you have a collection of comments, each referencing a different parent type (Post, Video, etc.), calling <code>$comments-&gt;load('parent')</code> is not sufficient, because the ORM needs to know all possible parent types to perform efficient eager loading. <code>loadMorphs()</code> lets you specify the possible types so Lightpack can fetch all parents in as few queries as possible.</p>
<h5 id="example-usage">Example Usage<a class="headerlink" href="#example-usage" title="Permanent link">&para;</a></h5>
<p>Suppose you fetch a set of comments:</p>
<pre><code class="language-php">$comments = Comment::query()-&gt;where('user_id', '=', 42)-&gt;all();
</code></pre>
<p>You can eager load their parents like this:</p>
<pre><code class="language-php">$comments-&gt;loadMorphs([
    Post::class,
    Video::class,
    Photo::class,
]);
</code></pre>
<p>Now, for each comment, <code>$comment-&gt;parent</code> will be the appropriate parent model instance, and all parents will have been loaded efficiently—no N+1 problem!</p>
<h5 id="best-practices-notes">Best Practices &amp; Notes<a class="headerlink" href="#best-practices-notes" title="Permanent link">&para;</a></h5>
<ul>
<li>Always specify all possible parent types for the morph relation.</li>
<li>Use <code>loadMorphs</code> after fetching the collection (not on the query builder).</li>
<li>This method is especially useful for API responses or UI screens showing polymorphic lists with their parents.</li>
<li>If you omit a possible type, parents of that type will not be eager loaded and may trigger lazy loading (and N+1 queries) if accessed.</li>
</ul>
<hr />
<h2 id="lazy-loading">Lazy Loading<a class="headerlink" href="#lazy-loading" title="Permanent link">&para;</a></h2>
<p>If you access a relation property that hasn't been loaded yet, Lightpack ORM will transparently execute a new query to fetch it. This aspect is know as <strong>lazy loading</strong> relationships.</p>
<pre><code class="language-php">$user = User::find(1); // No relations loaded
$posts = $user-&gt;posts; // Triggers a query to fetch posts for this user
</code></pre>
<ul>
<li>The first time you access <code>$user-&gt;posts</code>, Lightpack issues a query and caches the result on the model instance.</li>
<li>Subsequent accesses to <code>$user-&gt;posts</code> use the cached data—no additional queries are made.</li>
</ul>
<h3 id="tradeoffs-and-risks">Tradeoffs and Risks<a class="headerlink" href="#tradeoffs-and-risks" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>N+1 Query Problem:</strong> If you loop over a collection and access a relation on each item, you can easily trigger many queries:</li>
</ul>
<p>```php
  $users = User::query()-&gt;all();</p>
<p>foreach ($users as $user) {
        $user-&gt;profile; // Triggers 1 profile query per user
  }
  ```</p>
<p>This leads to poor performance and unpredictable database load.</p>
<ul>
<li>
<p><strong>Performance Unpredictability:</strong> Lazy loading can make it hard to know how many queries your code will run, especially as your data grows.</p>
</li>
<li>
<p><strong>Best Practice:</strong> Always prefer eager loading (<code>with()</code>, <code>load()</code>) for predictable, efficient queries. Use lazy loading only if you are certain the relation will be accessed infrequently or in non-performance-critical code (e.g., admin dashboards, prototypes).</p>
</li>
</ul>
<h3 id="when-is-lazy-loading-acceptable">When is Lazy Loading Acceptable?<a class="headerlink" href="#when-is-lazy-loading-acceptable" title="Permanent link">&para;</a></h3>
<ul>
<li>For small datasets, prototyping, or admin tools where performance is not critical.</li>
<li>When you explicitly whitelist certain relations using <code>allowedLazyRelations</code> in strict mode.</li>
</ul>
<hr />
<h2 id="strict-mode-lazy-loading">Strict Mode &amp; Lazy Loading<a class="headerlink" href="#strict-mode-lazy-loading" title="Permanent link">&para;</a></h2>
<p>Preventing <strong><code>N+1</code></strong> query issues and ensuring predictable performance is a core principle in Lightpack ORM. While eager loading is the primary tool for fetching related data efficiently, Lightpack also offers <strong>strict mode</strong> for even greater safety and explicitness.</p>
<blockquote>
<p><strong>Tip:</strong> For maximum safety against N+1 issues, enable strict mode on your models. See the section below for details.</p>
</blockquote>
<h3 id="what-is-strict-mode">What is Strict Mode?<a class="headerlink" href="#what-is-strict-mode" title="Permanent link">&para;</a></h3>
<p>Strict mode prevents accidental lazy loading of relations. In strict mode, if you try to access a relation that was not eager loaded (via <code>with</code>, <code>load</code>, etc.), Lightpack will throw an exception—unless that relation is explicitly whitelisted. This is crucial for API performance, large-scale applications, and when you want to guarantee predictable queries.</p>
<h3 id="how-to-enable-strict-mode">How to Enable Strict Mode<a class="headerlink" href="#how-to-enable-strict-mode" title="Permanent link">&para;</a></h3>
<p>Enable strict mode by setting the following property on your model:</p>
<pre><code class="language-php">protected $strictMode = true;
</code></pre>
<p>Optionally, you can allow specific relations to be lazy loaded by whitelisting them:</p>
<pre><code class="language-php">protected $allowedLazyRelations = ['profile', 'roles'];
</code></pre>
<h3 id="how-it-works">How It Works<a class="headerlink" href="#how-it-works" title="Permanent link">&para;</a></h3>
<ul>
<li>Accessing a relation that was not eager loaded or whitelisted throws an exception.</li>
<li>Only eager loaded relations or whitelisted <code>allowedLazyRelations</code> can be accessed without error.</li>
<li>This ensures all relation access is explicit and safe for large-scale or API use.</li>
</ul>
<h3 id="example-strict-mode-in-action">Example: Strict Mode in Action<a class="headerlink" href="#example-strict-mode-in-action" title="Permanent link">&para;</a></h3>
<pre><code class="language-php">class User extends Model
{
    protected $strictMode = true;
    protected $allowedLazyRelations = ['profile'];
}

// Eager loading
$user = User::query()-&gt;with('roles')-&gt;one(); // OK
$user-&gt;roles; // OK

// Not eager loaded and not whitelisted
$user = new User($id); // No eager load

// Throws exception
$user-&gt;roles;

// Whitelisted lazy relation
$user-&gt;profile; // OK
</code></pre>
<hr />












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>